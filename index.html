<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Workers On-Boarding</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --muted: #666666;
      --primary: #0b5fff;
      --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--fg);
      background: var(--bg);
    }
    header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    main {
      max-width: 860px;
      margin: 0 auto;
      padding: 16px;
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 640px) {
      .grid-2 { grid-template-columns: repeat(2, 1fr); }
      .grid-3 { grid-template-columns: repeat(3, 1fr); }
    }
    label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input, select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      background: #fff;
    }
    input[type="date"] { padding: 8px 10px; }
    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin: 8px 0 12px;
    }
    .row { margin-bottom: 12px; }
    .actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    button {
      appearance: none;
      border: none;
      border-radius: 6px;
      padding: 12px 16px;
      font-size: 15px;
      font-weight: 600;
      color: #fff;
      background: var(--primary);
      cursor: pointer;
    }
    button[disabled] { opacity: 0.6; cursor: not-allowed; }
    .note { font-size: 12px; color: var(--muted); }
    .hidden { display: none !important; }
    .success {
      border: 1px solid #d1fae5;
      background: #ecfdf5;
      color: #065f46;
      padding: 12px;
      border-radius: 6px;
      margin-top: 12px;
    }
    .printable h2 { margin: 0 0 8px; font-size: 18px; }
    .printable table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    .printable th, .printable td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 13px;
      text-align: left;
      vertical-align: top;
    }
    .doc-links a { word-break: break-all; font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <h1>Workers On-Boarding</h1>
  </header>

  <main>
    <form id="onboardForm" class="card" autocomplete="on">
      <div class="section-title">Personal details</div>
      <div class="grid grid-2">
        <div class="row">
          <label>Name</label>
          <input type="text" name="Name" required>
        </div>
        <div class="row">
          <label>Date of Birth</label>
          <input type="date" name="Date of Birth" required>
        </div>
        <div class="row">
          <label>Gender</label>
          <select name="Gender" required>
            <option value="">Select</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
          </select>
        </div>
        <div class="row">
          <label>Designation</label>
          <input type="text" name="Designation" required>
        </div>
        <div class="row">
          <label>Grade</label>
          <select name="Grade" required>
            <option value="">Select</option>
            <option>Unskilled</option>
            <option>Semi-skilled</option>
            <option>Skilled</option>
            <option>Supervisor</option>
          </select>
        </div>
        <div class="row">
          <label>Blood Group</label>
          <select name="Blood Group" required>
            <option value="">Select</option>
            <option>A+</option><option>A-</option>
            <option>B+</option><option>B-</option>
            <option>O+</option><option>O-</option>
            <option>AB+</option><option>AB-</option>
          </select>
        </div>
        <div class="row">
          <label>Marital Status</label>
          <select name="Marital Status" required>
            <option value="">Select</option>
            <option>Single</option>
            <option>Married</option>
            <option>Divorced</option>
            <option>Widowed</option>
          </select>
        </div>
        <div class="row">
          <label>Father Name</label>
          <input type="text" name="Father Name" required>
        </div>
        <div class="row">
          <label>Contact Number</label>
          <input type="tel" name="Contact Number" pattern="[0-9]{10}" required>
        </div>
        <div class="row">
          <label>Emergency Contact Name</label>
          <input type="text" name="Emergency Contact Name" required>
        </div>
        <div class="row">
          <label>Emergency Contact Relation</label>
          <select name="Emergency Contact Relation" required>
            <option value="">Select</option>
            <option>Father</option>
            <option>Mother</option>
            <option>Spouse</option>
            <option>Sibling</option>
            <option>Friend</option>
            <option>Other</option>
          </select>
        </div>
        <div class="row">
          <label>State</label>
          <select name="State" required>
            <option value="">Select</option>
            <option>Gujarat</option>
            <option>Maharashtra</option>
            <option>Rajasthan</option>
            <option>Madhya Pradesh</option>
            <option>Uttar Pradesh</option>
            <option>Punjab</option>
            <option>Haryana</option>
            <option>Delhi</option>
            <option>Other</option>
          </select>
        </div>
        <div class="row">
          <label>Work Location</label>
          <input type="text" name="Work Location" required>
        </div>
        <div class="row">
          <label>Client Name</label>
          <input type="text" name="Client Name" required>
        </div>
      </div>

      <div class="section-title">Bank & statutory</div>
      <div class="grid grid-2">
        <div class="row">
          <label>Bank Name</label>
          <input type="text" name="Bank Name" required>
        </div>
        <div class="row">
          <label>Account Number</label>
          <input type="text" name="Account Number" required>
        </div>
        <div class="row">
          <label>IFSC Code</label>
          <input type="text" name="IFSC Code" required>
        </div>
        <div class="row">
          <label>UAN Number</label>
          <input type="text" name="UAN Number">
        </div>
        <div class="row">
          <label>ESI No / WC Policy</label>
          <input type="text" name="ESI No / WC Policy">
        </div>
        <div class="row">
          <label>Aadhaar Number</label>
          <input type="text" name="Aadhaar Number" required>
        </div>
        <div class="row">
          <label>PAN Number</label>
          <input type="text" name="PAN Number">
        </div>
        <div class="row">
          <label>Education</label>
          <select name="Education" required>
            <option value="">Select</option>
            <option>Primary</option>
            <option>Secondary</option>
            <option>Higher Secondary</option>
            <option>Diploma</option>
            <option>Graduate</option>
            <option>Postgraduate</option>
          </select>
        </div>
        <div class="row">
          <label>Scaffolding Work Experience</label>
          <select name="Scaffolding Work Experience" required>
            <option value="">Select</option>
            <option>0-6 months</option>
            <option>6-12 months</option>
            <option>1-2 years</option>
            <option>2-5 years</option>
            <option>5+ years</option>
          </select>
        </div>
      </div>

      <div class="section-title">Family details</div>
      <div class="grid grid-2">
        <div class="row">
          <label>Father Name & DOB</label>
          <input type="text" name="Father Name & DOB">
        </div>
        <div class="row">
          <label>Mother Name & DOB</label>
          <input type="text" name="Mother Name & DOB">
        </div>
        <div class="row">
          <label>Date of Marriage</label>
          <input type="date" name="Date of Marriage">
        </div>
        <div class="row">
          <label>Wife Name & DOB</label>
          <input type="text" name="Wife Name & DOB">
        </div>
        <div class="row">
          <label>Number of Children</label>
          <select name="Number of Children">
            <option value="">Select</option>
            <option>0</option><option>1</option><option>2</option><option>3</option>
          </select>
        </div>
      </div>

      <div class="grid grid-3">
        <div class="row">
          <label>Child 1 Name</label>
          <input type="text" name="Child 1 Name">
        </div>
        <div class="row">
          <label>Child 1 Gender</label>
          <select name="Child 1 Gender">
            <option value="">Select</option>
            <option>Son</option><option>Daughter</option>
          </select>
        </div>
        <div class="row">
          <label>Child 1 DOB</label>
          <input type="date" name="Child 1 DOB">
        </div>

        <div class="row">
          <label>Child 2 Name</label>
          <input type="text" name="Child 2 Name">
        </div>
        <div class="row">
          <label>Child 2 Gender</label>
          <select name="Child 2 Gender">
            <option value="">Select</option>
            <option>Son</option><option>Daughter</option>
          </select>
        </div>
        <div class="row">
          <label>Child 2 DOB</label>
          <input type="date" name="Child 2 DOB">
        </div>

        <div class="row">
          <label>Child 3 Name</label>
          <input type="text" name="Child 3 Name">
        </div>
        <div class="row">
          <label>Child 3 Gender</label>
          <select name="Child 3 Gender">
            <option value="">Select</option>
            <option>Son</option><option>Daughter</option>
          </select>
        </div>
        <div class="row">
          <label>Child 3 DOB</label>
          <input type="date" name="Child 3 DOB">
        </div>
      </div>

      <div class="section-title">Document uploads (mandatory)</div>
      <div class="grid grid-2">
        <div class="row">
          <label>Aadhaar Front</label>
          <input type="file" name="Aadhaar Front" accept="image/*,application/pdf" required>
        </div>
        <div class="row">
          <label>Aadhaar Back</label>
          <input type="file" name="Aadhaar Back" accept="image/*,application/pdf" required>
        </div>
        <div class="row">
          <label>Bank Passbook</label>
          <input type="file" name="Bank Passbook" accept="image/*,application/pdf" required>
        </div>
        <div class="row">
          <label>Passport Size Photo</label>
          <input type="file" name="Passport Size Photo" accept="image/*" required>
        </div>
      </div>

      <div class="note">Submission runs until data and files are saved. Do not refresh during submission.</div>

      <div class="actions">
        <button id="submitBtn" type="submit">Submit</button>
      </div>

      <div id="status" class="success hidden">Submitted successfully.</div>
    </form>

    <section id="printSection" class="card hidden printable"></section>
  </main>

  <script>
    // Replace with your deployed Apps Script Web App URL
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx1BIMh3xSkzNwWkbSbdXZPp-MCd_qbwwLaDM0q3m01UIHgOAtSNnX4lNsmZ2zYNvfD/exec';

    const formEl = document.getElementById('onboardForm');
    const submitBtn = document.getElementById('submitBtn');
    const statusEl = document.getElementById('status');
    const printSection = document.getElementById('printSection');

    let submissionLocked = false;

    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (submissionLocked) return;

      // Basic required file validation
      const files = {
        aadhaarFront: formEl.querySelector('input[name="Aadhaar Front"]').files[0],
        aadhaarBack: formEl.querySelector('input[name="Aadhaar Back"]').files[0],
        bankPassbook: formEl.querySelector('input[name="Bank Passbook"]').files[0],
        passportPhoto: formEl.querySelector('input[name="Passport Size Photo"]').files[0]
      };
      if (!files.aadhaarFront || !files.aadhaarBack || !files.bankPassbook || !files.passportPhoto) {
        alert('Please upload all mandatory documents.');
        return;
      }

      // Lock submission
      submissionLocked = true;
      submitBtn.classList.add('hidden');
      submitBtn.disabled = true;

      try {
        const formData = collectFormData(formEl);
        const filePayload = {
          aadhaarFront: await fileToBase64(files.aadhaarFront),
          aadhaarBack: await fileToBase64(files.aadhaarBack),
          bankPassbook: await fileToBase64(files.bankPassbook),
          passportPhoto: await fileToBase64(files.passportPhoto)
        };

        const payload = {
          form: formData,
          files: {
            aadhaarFront: {
              name: files.aadhaarFront.name,
              mimeType: files.aadhaarFront.type,
              data: filePayload.aadhaarFront
            },
            aadhaarBack: {
              name: files.aadhaarBack.name,
              mimeType: files.aadhaarBack.type,
              data: filePayload.aadhaarBack
            },
            bankPassbook: {
              name: files.bankPassbook.name,
              mimeType: files.bankPassbook.type,
              data: filePayload.bankPassbook
            },
            passportPhoto: {
              name: files.passportPhoto.name,
              mimeType: files.passportPhoto.type,
              data: filePayload.passportPhoto
            }
          }
        };

        const res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const json = await res.json();
        if (json.status !== 'SUCCESS') {
          throw new Error(json.message || 'Submission failed');
        }

        statusEl.classList.remove('hidden');
        renderPrintable(formData, json.serial, json.fileUrls);
        autoDownloadPrintable();
        window.print();

      } catch (err) {
        alert('Submission error: ' + String(err));
        // Keep button hidden to prevent duplicate entries; refresh to retry
      }
    });

    function collectFormData(form) {
      const data = {};
      const fields = form.querySelectorAll('input[name], select[name]');
      fields.forEach(el => {
        const name = el.getAttribute('name');
        if (el.type === 'file') return;
        data[name] = el.value || '';
      });

      // Sheet-only fields (not visible in UI) â€” keep empty placeholders
      const sheetOnly = [
        'Date of Joining','Project Code','Gross Salary','Current Address','Worker Location',
        'PF Location','UAN Remarks','ESI Remarks','Email ID'
      ];
      sheetOnly.forEach(k => { if (!(k in data)) data[k] = ''; });

      return data;
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function renderPrintable(formData, serial, fileUrls) {
      const rows = [];
      const showFields = [
        'Serial','Name','Date of Birth','Gender','Designation','Grade','Blood Group','Marital Status',
        'Father Name','Contact Number','Emergency Contact Name','Emergency Contact Relation','State',
        'Work Location','Client Name','Bank Name','Account Number','IFSC Code','UAN Number',
        'ESI No / WC Policy','Aadhaar Number','PAN Number','Education','Scaffolding Work Experience',
        'Father Name & DOB','Mother Name & DOB','Date of Marriage','Wife Name & DOB','Number of Children',
        'Child 1 Name','Child 1 Gender','Child 1 DOB','Child 2 Name','Child 2 Gender','Child 2 DOB',
        'Child 3 Name','Child 3 Gender','Child 3 DOB'
      ];

      const merged = Object.assign({}, formData);
      merged['Serial'] = serial;

      showFields.forEach(k => {
        rows.push(`<tr><th>${escapeHtml(k)}</th><td>${escapeHtml(merged[k] || '')}</td></tr>`);
      });

      const docsHtml = `
        <div class="doc-links">
          <p><strong>Aadhaar Front:</strong> <a href="${fileUrls.aadhaarFront}" target="_blank">${fileUrls.aadhaarFront}</a></p>
          <p><strong>Aadhaar Back:</strong> <a href="${fileUrls.aadhaarBack}" target="_blank">${fileUrls.aadhaarBack}</a></p>
          <p><strong>Bank Passbook:</strong> <a href="${fileUrls.bankPassbook}" target="_blank">${fileUrls.bankPassbook}</a></p>
          <p><strong>Passport Photo:</strong> <a href="${fileUrls.passportPhoto}" target="_blank">${fileUrls.passportPhoto}</a></p>
        </div>
      `;

      printSection.innerHTML = `
        <h2>On-Boarding Form</h2>
        <table>${rows.join('')}</table>
        <h3 style="margin-top:12px;">Attached documents</h3>
        ${docsHtml}
      `;
      printSection.classList.remove('hidden');
    }

    function autoDownloadPrintable() {
      const html = `
        <!doctype html>
        <html><head><meta charset="utf-8"><title>On-Boarding</title></head>
        <body>${printSection.innerHTML}</body></html>
      `;
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'onboarding.html';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        URL.revokeObjectURL(url);
        a.remove();
      }, 1000);
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
  </script>
</body>
</html>
